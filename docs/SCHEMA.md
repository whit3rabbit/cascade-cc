# Repository JSON Schemas

This document describes the structure and purpose of the various JSON files used throughout the repository for analysis, deobfuscation, and machine learning.

## Table of Contents
1. [graph_map.json](#graph_mapjson)
2. [simplified_asts.json](#simplified_astsjson)
3. [logic_db.json](#logic_dbjson)
4. [mapping.json](#mappingjson)
5. [logic_registry.json](#logic_registryjson)
6. [knowledge_base.json](#knowledge_basejson)

---

## graph_map.json
**Location:** `./cascade_graph_analysis/<version>/metadata/graph_map.json`

This file contains high-level metadata about the deobfuscated chunks and their relationships.

### Structure
```json
{
  "chunks": [
    {
      "name": "chunk001",
      "displayName": "PrettyName",
      "file": "chunks/chunk001_PrettyName.js",
      "moduleId": "module_42",
      "affinityLink": "chunk000",
      "isGoldenMatch": false,
      "proposedPath": "src/utils.ts",
      "tokens": 1234,
      "startLine": 1,
      "endLine": 100,
      "category": "priority",
      "label": "CORE_LOGIC",
      "role": "MODULE",
      "state_touchpoints": ["sessionId"],
      "centrality": 0.05,
      "score": 0.051,
      "neighborCount": 5,
      "outbound": ["chunk002", "chunk005"],
      "kb_info": {
        "suggested_path": "src/utils.ts",
        "description": "Utility helpers",
        "weighted_sum": 10
      },
      "hints": [],
      "hasGenerator": false,
      "hasStateMutator": false,
      "error_signature": null,
      "startsWithImport": true
    }
  ],
  "file_ranges": [
    {
      "path": "src/utils.ts",
      "ranges": [
        { "start": 1, "end": 100 }
      ]
    }
  ]
}
```

---

## simplified_asts.json
**Location:** `./cascade_graph_analysis/<version>/metadata/simplified_asts.json`

A structural representation of the AST for each chunk, stripped of names and values to allow for cross-version structural alignment.

### Structure
```json
{
  "chunk001": {
    "type": "FunctionDeclaration",
    "name": "f",
    "children": [
      {
        "type": "BlockStatement",
        "slot": "body",
        "children": [...]
      }
    ]
  }
}
```
*Note: Includes `valHash` for literals and `call` for call expressions.*

---

## logic_db.json
**Location:** `./cascade_graph_analysis/<version>/metadata/logic_db.json`

Vectorized representations of chunks generated by the ML model (`ml/vectorize.py`), used for structural anchoring.

### Structure
```json
[
  {
    "name": "chunk001",
    "vector": [0.1, -0.2, ...],
    "symbols": [
      {
        "name": "mangled_name",
        "key": "FunctionDeclaration/body/BlockStatement[0]/..."
      }
    ]
  }
]
```

---

## mapping.json
**Location:** `./cascade_graph_analysis/<version>/metadata/mapping.json`

The central registry of renamed identifiers for a specific version, including similarity matches that inform naming decisions.

### Structure
```json
{
  "version": "1.2",
  "matches": {
    "chunk001": {
      "label": "zod_v3_23_8",
      "similarity": 0.96,
      "is_library_match": true
    }
  },
  "variables": {
    "a": {
      "name": "resolved_name",
      "confidence": 0.95,
      "source": "anchored_key_logic_registry"
    }
  },
  "properties": {
    "b": {
      "name": "property_name",
      "confidence": 0.8,
      "source": "llm"
    }
  },
  "processed_chunks": ["chunk001"],
  "metadata": {
    "total_renamed": 1500,
    "last_updated": "2024-01-15T12:00:00Z"
  }
}
```

---

## logic_registry.json
**Location:** `./cascade_graph_analysis/logic_registry.json`

A global database that maps structural logic vectors to confirmed names. This allows the system to recognize known library code or common patterns across different targets.

### Structure
```json
{
  "unique_logic_label": {
    "vector": [...],
    "symbols": [...],
    "resolved_variables": { "a": "resolved_name" },
    "resolved_properties": { "b": "property_name" }
  }
}
```

---

## knowledge_base.json
**Location:** `./knowledge_base.json`

Hand-crafted or bootstrapped rules used by `src/analyze.js` to identify chunks before ML or LLM passes.

### Structure
```json
{
  "file_anchors": [
    {
      "suggested_path": "src/utils/fileUtils.ts",
      "suggested_name": "fileUtils",
      "description": "File system utilities",
      "trigger_keywords": ["fs", "path", "readFile"]
    }
  ],
  "name_hints": [...],
  "error_anchors": [...]
}
```
